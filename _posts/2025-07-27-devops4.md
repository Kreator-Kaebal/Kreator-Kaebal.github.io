---
layout: post
title: 최종 프로젝트 인프라 구축②-내부 네트워크 연결시 인터넷 문제
categories: [devops]
tags: [virtualbox, linux]
excerpt: VM끼리 연결하고 인터넷도 쓰기
---

# VM끼리 연결하고 인터넷도 쓰는 간단글

## 개요

이번에는 VM을 연결하면서 생긴 인터넷 연결 오류에 대해 알아보겠다.

## 내부 서버 연결

[지난 시간](https://kreator-kaebal.github.io/posts/devops3/)에 말했듯이, 프로젝트를 개발 환경에서 운영하기 위해 가상서버 2대를 만들었다.  

두 서버를 인터넷에 연결하고, 서로 사설 IP로 통신시키기 위해
(사실 클러스터는 클라우드 구조도상 인터넷에 연결시키면 안 되지만...minikube 등을 설치하려면 인터넷 연결이 필요하니)

![do4-img1](/images/posts/devops4-img1.png)

가상머신을 만들면 기본으로 주는 NAT 어댑터에

![do4-img2](/images/posts/devops4-img2.png)

추가로 **호스트 전용 어댑터**를 달아주었다.

![do4-img3](/images/posts/devops4-img3.png)

서버에 들어가 nmtui 등지로 새 어댑터에 사설 IP를 달아주고 재시작 하자.

당직은 **192.168.0.100/24(클라스터), 192.168.0.101/24(젠킨스)**, 게이트웨이는 **192.168.0.1**로 하였다.  
어차피 내부 통신을 위한 어댑터이니 DNS 주소는 필요 없다.

## 인터넷 연결 문제

이렇게 하면 ping 192.168.0.101 등으로 테스트할 때 서로 연결이 되는 것을 볼 수 있다.  

문제는 IP 설정하기 전까지 멀쩡했던 인터넷 연결이 되지 않는다!

이 문제는 **/etc/sysconfig/network-scripts/ifcfg-(인터페이스명)** 파일에 그 원인이 있는데...

![do4-img4](/images/posts/devops4-img4.png)

위 사진은 호스트 전용 어댑터의 ifcfg 파일이다. 형광펜 친 **DEFROUTE** 설정에 주목해야 한다.

이게 yes로 되어 있으면 **이 인터페이스도 인터넷 라우팅에 사용**한다는 것이다.

따라서 인터넷 연결이 되지 않은 것은, 두 어댑터가 모두 인터넷 라우팅에 사용되는데  
내부용 어댑터가 모종의 이유로 라우팅에 우선 사용되고, 이건 당연히 인터넷 연결 되어 있지 않으니 안되는 것이다.  
(나중에 확인해 보니 가장 마지막 인터페이스가 기본 라우팅 어댑터로 사용된다 한다)

어차피 라우팅과 전~혀 관계 없는 어댑터니까, **DEFROUTE를 no**로 설정하고 네트워크를 재시작 해주면 끝~!

참고로, 네트웤을 재시작 할 때 CentOS 7까지의 **systemctl restart network**는 8버전(록키)부터 되지 않으니,
**nmcli con reload**로 재시작 해줘야 한다.